Parameters:
  StageName:
    Default: "${self:custom.stageName}"
    Description: The name of the current stage
    Type: String

Resources:
  LambdaMailerBounceTable:
    Type: AWS::DynamoDB::Table
    Properties:
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
      - AttributeName: messageId
        AttributeType: S
      - AttributeName: snsPublishTime
        AttributeType: S
      - AttributeName: destinationAddress
        AttributeType: S

      KeySchema:
      - AttributeName: messageId
        KeyType: HASH
      - AttributeName: snsPublishTime
        KeyType: RANGE

      GlobalSecondaryIndexes:
      - IndexName: EmailIndex
        KeySchema:
        - AttributeName: destinationAddress
          KeyType: HASH
        Projection:
          ProjectionType: ALL
      TimeToLiveSpecification:
        AttributeName: ttl
        Enabled: true

  MailerAttachments:
    Type: AWS::S3::Bucket
    Properties:
      LifecycleConfiguration:
        Rules:
          - ExpirationInDays: 30
            Id: delete-after-30-days
            Status: Enabled

  CreateTestDBPolicy:
    Type: AWS::IAM::ManagedPolicy
    Properties:
      Description: Policy for third arties to add files to the mailer attachments bucket
      Path: "/"
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Action: "s3:PutObject"
            Resource:
              Fn::GetAtt: [MailerAttachments, Arn]


Outputs:
  LambdaMailerTopicArn:
    Value:
      Fn::Join: [":", ["arn:aws:sns", Ref: "AWS::Region", Ref: "AWS::AccountId", "${self:custom.stageName}-mailer"]]
    Export:
      Name:
        Fn::Join: ["-", [Ref: StageName, "lambda-mailer-topic-arn"]]

  LambdaMailerBounceTopicArn:
    Value:
      Fn::Join: [":", ["arn:aws:sns", Ref: "AWS::Region", Ref: "AWS::AccountId", "${self:custom.stageName}-mailer-bounce"]]
    Export:
      Name:
        Fn::Join: ["-", [Ref: StageName, "lambda-mailer-bounce-topic-arn"]]

  EmailBounceAndComplaintTable:
    Value:
      Ref: LambdaMailerBounceTable

  MailerAttachmentsS3BucketArn:
    Value:
      Fn::GetAtt: [MailerAttachments, Arn]
    Description: ARN of S3 bucket for storing mailer attachments
    Export:
      Name:
        Fn::Join: ["-", [Ref: StageName, "lambda-mailer-attachments-arn"]]

  MailerAttachmentsS3BucketName:
    Value:
      Ref: MailerAttachments
    Description: Name of S3 bucket for storing mailer attachments
    Export:
      Name:
        Fn::Join: ["-", [Ref: StageName, "lambda-mailer-attachments"]]
